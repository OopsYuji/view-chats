version: "3.9"

services:
  server:
    build:
      context: ./server
    env_file:
      - .env
    environment:
      PORT: ${PORT:-4000}
      DATABASE_URL: ${DATABASE_URL}
      PGHOST: ${PGHOST:-localhost}
      PGPORT: ${PGPORT:-5432}
      PGDATABASE: ${PGDATABASE:-chats}
      PGUSER: ${PGUSER:-postgres}
      PGPASSWORD: ${PGPASSWORD:-supersecret}
      PGSSLMODE: ${PGSSLMODE:-disable}
      PGSSLREJECTUNAUTHORIZED: ${PGSSLREJECTUNAUTHORIZED:-false}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173,http://localhost:8080}
    ports:
      - "${SERVER_PORT:-4000}:4000"
    restart: unless-stopped

  web:
    build:
      context: ./web
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://server:4000}
        VITE_GOOGLE_CLIENT_ID: ${VITE_GOOGLE_CLIENT_ID:-}
    depends_on:
      server:
        condition: service_started
    ports:
      - "${WEB_PORT:-8081}:80"
    restart: unless-stopped
